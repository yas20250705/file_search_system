ファイル検索システム 取扱説明書

========================================

## 1. 概要

このアプリケーションは、指定したフォルダ内にあるファイルを全文検索するためのシステムです。
PDF、Office文書（Word, Excel, PowerPoint）、テキストファイルなど、様々な形式のファイルから内容を抽出し、高速に検索することができます。

主な特徴：
- 複数のインデックスを管理可能（複数のフォルダを別々にインデックス化）
- 高速な全文検索（SQLite FTS5 + trigramトークナイザーによる前方一致・部分一致対応）
- 詳細検索フィルター（ファイル種別、変更日時、作成日時）
- 差分更新機能（新規・更新・削除されたファイルのみ処理）
- LLM用エクスポート機能（ChatGPT等に読み込ませるためのMarkdown形式出力）


## 2. 起動方法

1. プロジェクトのルートディレクトリで、ターミナル（コマンドプロンプトやPowerShell）を開きます。
2. 以下のコマンドを実行して、必要なパッケージをインストールします（初回のみ）。

    ```
    pip install -r requirements.txt
    ```

3. 以下のコマンドを実行して、Webサーバーを起動します。

    ```
    uvicorn main:app --reload
    ```

    または、Windowsの場合は `start_app.bat` をダブルクリックして起動することもできます。

4. サーバーが起動したら、Webブラウザで `http://127.0.0.1:8000` にアクセスしてください。


## 3. 使用方法

### 3.1. 設定ページ (`/settings`)

アプリケーションを初めて使用する際や、検索対象を追加・変更したい場合は、まず設定ページにアクセスします。
画面上部の「設定」リンクから移動できます。

#### 新しいインデックスの追加

1. 「新しいインデックスの追加」セクションで、以下を設定します：
   - **インデックス名**: このインデックスの識別名（例: "マイドキュメント"）
   - **検索対象ディレクトリ**: 検索したいファイルが保存されているフォルダのフルパス（例: `C:\Users\YourName\Documents`）
   - **許可するファイル拡張子**: 検索対象としたいファイルの拡張子にチェックを入れます
     - テキスト系: `.txt`, `.md`, `.csv`, `.json`, `.xml`
     - ドキュメント系: `.pdf`, `.xlsx`, `.docx`, `.pptx`

2. 「インデックスを追加」ボタンをクリックして保存します。

#### インデックスの作成

1. 「既存のインデックス」セクションで、作成したいインデックスを確認します。
2. 「インデックス作成」ボタンをクリックします。
   - すべてのファイルを再インデックス化します（初回作成時や、完全に再構築したい場合に使用）
3. インデックス作成がバックグラウンドで開始されます。進捗状況は画面に表示されます。
   - 「ステータス」が `完了` になれば完了です。
4. インデックス作成を途中で止めたい場合は、「中止」ボタンをクリックしてください。

#### インデックスの更新（差分更新）

検索対象のファイルを追加・更新・削除した場合、完全に再インデックス化する必要はありません。

1. 「既存のインデックス」セクションで、更新したいインデックスの「更新」ボタンをクリックします。
2. システムが自動的に以下を検出して処理します：
   - **新規ファイル**: データベースに追加
   - **更新ファイル**: タイムスタンプが異なるファイルを更新
   - **削除ファイル**: ディスクに存在しないファイルをデータベースから削除
   - **変更なし**: スキップ（処理時間を短縮）
3. 差分更新の進捗状況も画面に表示されます。

※注意：差分更新は、既にインデックスが作成されている場合のみ使用できます。初回は「インデックス作成」ボタンを使用してください。

#### インデックスの削除

不要になったインデックスは「削除」ボタンで削除できます。削除すると、関連するデータベースファイルも削除されます。


### 3.2. 検索ページ (トップページ `/`)

インデックス作成が完了したら、トップページでファイルを検索できます。

#### 基本的な検索

1. 「検索対象インデックス」ドロップダウンから、検索したいインデックスを選択します。
2. 検索ボックスにキーワードを入力し、「検索」ボタンをクリックするか、Enterキーを押します。
3. 検索結果が、ファイルパスと、キーワードを含む内容の一部（スニペット）と共に一覧表示されます。
   - キーワードは `<b>` タグで強調表示されます。
   - 各結果には作成日時と変更日時も表示されます。
4. ファイルパスをクリックすると、PC上でそのファイルが（関連付けられたアプリケーションで）開きます。

#### 高度な検索機能

**検索演算子**:
- **AND検索**（デフォルト）: スペース区切りで全ての語を含む（例: `python tutorial`）
- **OR検索**: `OR` または `|` 演算子を使用（例: `python OR tutorial`）
- **除外ワード**: `-` プレフィックスで除外（例: `python -tutorial`）
- **フレーズ検索**: `"..."` で囲む（例: `"machine learning"`）
- **厳密フレーズ検索**: `""...""` で囲む（二重引用符2つ）

**前方一致・部分一致**:
- 3文字以上の検索語は自動的に前方一致・部分一致で検索されます（trigramトークナイザー使用）
- 2文字以下の検索語はLIKE検索にフォールバックします

#### 詳細検索フィルター

「詳細検索」パネルを開くと、以下のフィルターを設定できます：

1. **ファイル種別**（複数選択可）:
   - 検索対象とするファイル種別をチェックボックスで選択します
   - 「すべて選択」で一括選択・解除が可能です
   - ※注意：ファイル種別を選択しないと検索できません

2. **変更日時**:
   - 今日、今週、今月、今年、年指定から選択
   - 年指定を選択した場合、年を入力（デフォルトは現在の年）

3. **作成日時**:
   - 変更日時と同様のオプション

4. 「常に表示」チェックボックスで、詳細検索パネルを常に開いた状態にできます。


### 3.3. LLM用エクスポート機能

検索結果をChatGPT等のLLMに読み込ませるためのMarkdown形式でエクスポートできます。

1. 検索を実行して結果を表示します。
2. エクスポートしたいドキュメントにチェックボックスでチェックを入れます。
   - 「すべて選択」で一括選択・解除が可能です。
3. 「LLM用エクスポート」ボタンをクリックします。
4. エクスポート設定モーダルで以下を設定します：
   - **1ファイルあたりの最大文字数**: デフォルトは100,000文字
     - プリセットボタンで簡単に設定可能：
       - 30,000文字（GPT-3.5向け）
       - 100,000文字（GPT-4向け）
       - 200,000文字（Claude向け）
   - 文字数制限を超える場合は、自動的に複数ファイルに分割され、ZIP形式でダウンロードされます
5. 「エクスポート実行」をクリックすると、Markdownファイルがダウンロードされます。

エクスポートされたMarkdownファイルには、各ドキュメントの以下の情報が含まれます：
- ファイルパス
- ファイル種別
- 作成日時
- 変更日時
- 本文（全文）


## 4. ファイル構成

- `main.py`: アプリケーションのメインプログラムです。Webサーバーと検索ロジックを実装しています。
- `database.py`: データベースの接続とテーブル作成を管理します。
- `indexer.py`: ファイルの内容を読み取り、データベースにインデックスを作成・更新します。
- `requirements.txt`: 必要なPythonパッケージの一覧です。
- `meta.db`: インデックス設定を保存するメタデータベースファイルです。
- `indexes/`: 各インデックスのデータベースファイルが格納されるディレクトリです。
- `app.log`: アプリケーションの動作ログが出力されるファイルです。エラー発生時の調査に役立ちます。
- `templates/`: HTMLテンプレートが格納されています。
  - `index.html`: 検索ページ
  - `settings.html`: 設定ページ
- `@manual.txt`: この取扱説明書です。


## 5. トラブルシューティング

### インデックス作成が完了しない

- `app.log` ファイルを確認してエラーメッセージを確認してください。
- ファイルが他のアプリケーションで開かれている場合、エラーになることがあります。ファイルを閉じてから再試行してください。

### 検索結果が表示されない

- インデックスが正しく作成されているか確認してください。
- 検索対象インデックスが正しく選択されているか確認してください。
- 詳細検索でファイル種別が選択されているか確認してください（ファイル種別を選択しないと検索できません）。

### ファイル種別がヒットしない

- インデックス作成時にそのファイル種別が許可されているか確認してください。
- ファイルが実際にインデックスされているか、設定ページでインデックスの状態を確認してください。

### 差分更新が動作しない

- 初回は「インデックス作成」ボタンを使用してください。差分更新は既存のインデックスがある場合のみ使用できます。
- データベースファイルが破損している可能性があります。その場合は、インデックスを削除して再作成してください。
